generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model SaasOwner {
  id       String @id @default(uuid())
  email    String @unique
  password String
}

model Tenant {
  id               String   @id @default(uuid())
  name             String
  slug             String   @unique
  whatsapp_number  String?  @unique
  whatsapp_status  String   @default("DISCONNECTED")
  status           String   @default("ACTIVE") // ACTIVE, BLOCKED
  owner_phone      String?
  logo_url         String?
  
  // Access Control Settings
  access_cooldown   Int     @default(5) // minutes between checkins
  max_daily_access  Int     @default(1)
  opening_time      String? // "06:00"
  closing_time      String? // "23:00"
  
  gate_token        String?  @unique
  turnstile_brand   String?  @default("generic")


  saas_plan_id     String?
  saas_plan        SaasPlan? @relation(fields: [saas_plan_id], references: [id])
  saas_plan_expires_at DateTime?
  
  // Asaas Integrations
  asaas_customer_id String?
  subscription_id   String?
  subscription_cycle String? // MONTHLY, YEARLY
  payment_method    String? // CREDIT_CARD, PIX
  payment_status    String  @default("PENDING") // PENDING, ACTIVE, OVERDUE
  is_free           Boolean @default(false)

  notificationSettings NotificationSettings?
  paymentHistory    PaymentHistory[]

  created_at       DateTime @default(now())
  
  admins           GymAdmin[]
  members          Member[]
  plans            Plan[]
  accessLogs       AccessLog[]
  securityLogs     SecurityLog[]
  invoices         Invoice[]
  leads            Lead[]
  chatMessages     ChatMessage[]
}

model SecurityLog {
  id          String   @id @default(uuid())
  tenant_id   String
  tenant      Tenant   @relation(fields: [tenant_id], references: [id])
  event_type  String   // SUSPICIOUS_ACTIVITY, MULTIPLE_FAILURES
  description String
  severity    String   // LOW, MEDIUM, HIGH, CRITICAL
  source      String?  // Phone number or RemoteJID
  created_at  DateTime @default(now())
}

model NotificationSettings {
  id              String   @id @default(uuid())
  tenant_id       String   @unique
  tenant          Tenant   @relation(fields: [tenant_id], references: [id])
  
  checkin_success String   @default("‚úÖ Acesso Liberado! Bom treino, {name}.")
  plan_warning    String   @default("‚ö†Ô∏è Ol√° {name}, seu plano venceu hoje. Passe na recep√ß√£o para renovar.")
  plan_expired    String   @default("üö´ {name}, seu plano venceu hoje. Passe na recep√ß√£o para renovar.")
  
  updated_at      DateTime @default(now())
}

model SaasPlan {
  id          String   @id @default(uuid())
  name        String
  price       Decimal
  description String?
  features    String? // JSON string
  max_members Int      @default(50)
  duration_months Int    @default(1)
  active          Boolean  @default(true)
  created_at  DateTime @default(now())
  tenants     Tenant[]
}

model PaymentHistory {
  id              String   @id @default(uuid())
  tenant_id       String
  tenant          Tenant   @relation(fields: [tenant_id], references: [id])
  amount          Decimal
  method          String // PIX, CREDIT_CARD
  status          String // PENDING, PAID, FAILED
  asaas_payment_id String?
  created_at      DateTime @default(now())
  paid_at         DateTime?
}

model GymAdmin {
  id            String   @id @default(uuid())
  email         String   @unique
  password      String
  name          String
  tenant_id     String
  tenant        Tenant   @relation(fields: [tenant_id], references: [id])
}

model Plan {
  id            String   @id @default(uuid())
  name          String
  price         Float
  duration_days Int
  tenant_id     String
  tenant        Tenant   @relation(fields: [tenant_id], references: [id])
  members       Member[]
}

model Member {
  id              String   @id @default(uuid())
  name            String
  phone           String
  active          Boolean  @default(true)
  
  plan_id         String?
  plan            Plan?    @relation(fields: [plan_id], references: [id])
  plan_start_date DateTime?
  plan_end_date   DateTime?
  
  cpf             String?
  address         String?
  
  diet_plan       String?
  workout_routine String?
  
  tenant_id       String
  tenant          Tenant   @relation(fields: [tenant_id], references: [id])

  accessLogs      AccessLog[]
  invoices        Invoice[]
  chatMessages    ChatMessage[]

  @@unique([phone, tenant_id])
}

model Invoice {
  id              String   @id @default(uuid())
  member_id       String
  member          Member   @relation(fields: [member_id], references: [id])
  tenant_id       String
  tenant          Tenant   @relation(fields: [tenant_id], references: [id])
  
  amount          Float
  description     String
  due_date        DateTime
  paid_at         DateTime?
  status          String   @default("PENDING") // PENDING, PAID, OVERDUE, CANCELLED
  payment_method  String?  // PIX, CASH, CREDIT_CARD
  
  created_at      DateTime @default(now())
}

model Lead {
  id              String   @id @default(uuid())
  tenant_id       String
  tenant          Tenant   @relation(fields: [tenant_id], references: [id])
  name            String?
  phone           String
  last_message    String?
  last_message_at DateTime @default(now())
  created_at      DateTime @default(now())
  
  messages        ChatMessage[]

  @@unique([phone, tenant_id])
}

model ChatMessage {
  id              String   @id @default(uuid())
  tenant_id       String
  tenant          Tenant   @relation(fields: [tenant_id], references: [id])
  lead_id         String?
  lead            Lead?    @relation(fields: [lead_id], references: [id])
  member_id       String?
  member          Member?  @relation(fields: [member_id], references: [id])
  
  content         String
  from_me         Boolean  @default(false)
  jid             String   // @s.whatsapp.net
  media_url       String?
  type            String   @default("text") // text, image, audio, etc
  
  created_at      DateTime @default(now())
}

model AccessLog {
  id        String   @id @default(uuid())
  scanned_at DateTime @default(now())
  status    String
  reason    String?
  
  member_id String?
  member    Member?  @relation(fields: [member_id], references: [id])
  
  tenant_id String
  tenant    Tenant   @relation(fields: [tenant_id], references: [id])
}

model SystemSettings {
  id        String   @id @default("global")
  site_name String   @default("ZapFitness")
  logo_url  String?
  updated_at DateTime @updatedAt
}
